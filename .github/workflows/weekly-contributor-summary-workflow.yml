name: Weekly Contribution Summary
on:
  schedule:
    # every monday at 1400 utc
    - cron: "0 14 * * 1"
  # allows manual dispatch
  workflow_dispatch:


jobs:
  contributor_summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Gather Contributor Stats
        id: stats
        run: |
          since=$(date -d "7 days ago" --utc +%Y-%m-%dT%H:%M:%SZ)
          echo "Collecting commits since $since..."
  
          commit_count=$(git rev-list --count --since="$since" HEAD)
          echo "Found $commit_count commits."

          
          start_date=$(date -d "7 days ago" '+%b %d')
          end_date=$(date '+%b %d')
          echo "### Weekly Project Activity ($start_date -> $end_date)" > summary.md
          echo "" >> summary.md
  
          if [ "$commit_count" -gt 0 ]; then
          {
            echo "- **Total commits this week:** $commit_count"
            echo ""
            echo "Keep up the great work, everyone!"
          } >> summary.md
          else
            echo "Nothing committed this week T.T" >> summary.md
          fi
          {
            echo ""
            echo "Generated on $(date -u)"
          } >> summary.md

      - name: Display Summary
        run: cat summary.md

      - name: Post to Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: | 
          content=$(cat summary.md | jq -Rs .)
          curl -H "Content-Type: application/json" \
                         -d "{\"content\": $content}" \
                         $DISCORD_WEBHOOK